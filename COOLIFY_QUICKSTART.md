# Coolify Quick Start Guide

This is a streamlined guide for deploying Claude Workflow Manager to Coolify. The configuration has been simplified based on real deployment issues and solutions.

---

## Prerequisites

- Coolify installed on your server (Ubuntu 20.04+ LTS)
- Server: 4+ vCPUs, 8+ GB RAM, 50+ GB SSD
- Anthropic API key from https://console.anthropic.com/
- Git repository with your code

---

## Deployment Steps

### 1. Push Your Code

```bash
git add .
git commit -m "Deploy to Coolify"
git push origin main
```

### 2. Create Application in Coolify

1. **Log into Coolify Dashboard**
2. **Create New Project** (if you don't have one)
3. **Add Resource → Public/Private Repository**
4. **Configure:**
   - Repository: `your-repo-url`
   - Branch: `main`
   - Build Pack: **Docker Compose**
   - Docker Compose Location: `docker-compose.coolify.yml`
   - Base Directory: `/`

### 3. Set Environment Variables

In Coolify UI, add:

```
ANTHROPIC_API_KEY=sk-ant-api03-your-key-here
MAX_CONCURRENT_JOBS=3
```

### 4. Configure Service Domains (CRITICAL STEP)

After creating the application, configure each service:

**Frontend Service:**
1. Click on `frontend` service
2. **Set Port**: `80`
3. **Set Domain**: Use the auto-generated domain from Coolify (e.g., `frontend-xyz.your-domain.com`)
4. Click **Save**

**Backend Service:**
1. Click on `backend` service
2. **Set Port**: `8000`
3. **Set Domain**: Use the auto-generated domain from Coolify (e.g., `backend-xyz.your-domain.com`)
4. Click **Save**

### 5. Deploy

1. Click **"Deploy"** button
2. Wait 5-10 minutes for build to complete
3. Monitor logs for any errors

### 6. Verify Deployment

**Check containers are running:**
```bash
ssh user@your-server
docker ps | grep your-project-id
```

**Test internally:**
```bash
# Get container IDs from docker ps
FRONTEND_ID=<your-frontend-container-id>
BACKEND_ID=<your-backend-container-id>

# Test frontend
docker exec $FRONTEND_ID curl -I http://localhost/

# Test backend
docker exec $BACKEND_ID curl http://localhost:8000/health
```

Both should return `200 OK`.

**Test externally:**
- Open your frontend domain in browser
- Should see the application interface (not 404!)

---

## Common Issues and Quick Fixes

### Issue: 404 Not Found

**Cause:** Domains not configured in Coolify UI

**Fix:**
1. Go to Coolify Dashboard
2. Click on service (frontend or backend)
3. Set **Port** (80 for frontend, 8000 for backend)
4. Set **Domain** (use auto-generated one)
5. Click Save
6. Wait 30 seconds
7. Try again

### Issue: Containers Not on Coolify Network

**Cause:** Containers can't communicate with Traefik proxy

**Fix:**
```bash
# SSH into server
ssh user@your-server

# Find container IDs
docker ps | grep your-project

# Connect to coolify network
docker network connect coolify <frontend-container-id>
docker network connect coolify <backend-container-id>
```

### Issue: SSL Certificate Errors

**Cause:** Let's Encrypt can't verify domain (rate limit or DNS issues)

**Fix:**
- Wait 1 hour if rate limited
- Verify DNS points to server IP: `dig your-domain.com`
- Use HTTP instead of HTTPS temporarily

### Issue: Environment Variables Not Set

**Cause:** Traefik sees literal `${VARIABLE_NAME}` in labels

**Fix:**
- Ensure environment variables are set in Coolify UI (not in docker-compose)
- Redeploy after adding variables

---

## Architecture Overview

```
Internet
    ↓
Traefik Proxy (Port 80/443)
    ↓
┌─────────────────────────────┐
│ Frontend Container (Port 80)│ ← nginx serving React app
└─────────────────────────────┘
    ↓ (internal network)
┌─────────────────────────────┐
│ Backend Container (Port 8000)│ ← FastAPI + Claude CLI
└─────────────────────────────┘
    ↓
Anthropic API
```

**Key Points:**
- No ports exposed directly (Traefik handles all routing)
- SSL certificates auto-generated by Traefik + Let's Encrypt
- Containers communicate via internal Docker network
- Persistent volumes for generated files

---

## Configuration Details

### Docker Compose Structure

```yaml
services:
  backend:
    # No ports: defined - Traefik handles routing
    # No networks: defined - Coolify manages networks
    # No labels: defined - Coolify generates Traefik labels
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:?}
      - MAX_CONCURRENT_JOBS=${MAX_CONCURRENT_JOBS:-3}
    volumes:
      - brand-data:/app/backend/brand-data
      - brief-outputs:/app/backend/brief-outputs
      - draft-outputs:/app/backend/draft-outputs
      - logs:/app/backend/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]

  frontend:
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
```

**What Coolify Adds Automatically:**
- Traefik routing labels
- Network configuration
- SSL certificate management
- Domain routing rules
- Health check monitoring

---

## Resource Recommendations

### Minimum (Testing):
- 2 vCPUs, 4 GB RAM
- MAX_CONCURRENT_JOBS=1

### Recommended (Production):
- 4-8 vCPUs, 8-16 GB RAM
- MAX_CONCURRENT_JOBS=3

### Heavy Load:
- 8-16 vCPUs, 16-32 GB RAM
- MAX_CONCURRENT_JOBS=5-10

**Per Concurrent Job:**
- ~1 GB RAM
- ~0.5-1 CPU core
- 2-15 minutes execution time

---

## Cost Estimate

**VPS Hosting (Monthly):**
- Hetzner: €12 ($14) - 4 vCPU, 8GB RAM
- Linode: $36 - 4 vCPU, 8GB RAM
- DigitalOcean: $48 - 4 vCPU, 8GB RAM

**Claude API Usage (Monthly):**
- Light: $20-50 (20-50 jobs)
- Medium: $50-150 (50-150 jobs)
- Heavy: $150-500 (150-500 jobs)

**Total: $50-550/month** depending on usage

---

## Monitoring

### Via Coolify Dashboard
- Container status (healthy/unhealthy)
- Real-time logs
- Resource usage (CPU/Memory)
- Deployment history

### Via SSH
```bash
# Container stats
docker stats

# Logs
docker logs -f <container-id>

# Disk usage
df -h
du -sh /var/lib/docker/volumes/*
```

### Application Health
```bash
# Check backend health
curl https://api.your-domain.com/health

# List active jobs
curl https://api.your-domain.com/api/jobs
```

---

## Updating the Application

### Method 1: Via Coolify UI (Recommended)
1. Push changes to Git
2. Click "Redeploy" in Coolify Dashboard
3. Wait for build to complete

### Method 2: Enable Auto-Deploy
1. In Coolify, copy webhook URL
2. Add to GitHub repository webhooks
3. Every push to `main` auto-deploys

---

## Backup Strategy

```bash
# Create backup script: /usr/local/bin/backup-claude-workflow.sh
#!/bin/bash
BACKUP_DIR="/backups/claude-workflow"
DATE=$(date +%Y%m%d)

mkdir -p $BACKUP_DIR

# Backup volumes
for vol in brand-data brief-outputs draft-outputs logs; do
    docker run --rm \
        -v coolify-${vol}:/data \
        -v $BACKUP_DIR:/backup \
        alpine tar czf /backup/${vol}-${DATE}.tar.gz /data
done

# Keep only last 7 days
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete

echo "Backup completed: $DATE"
```

**Schedule with cron:**
```bash
# Daily backup at 2 AM
0 2 * * * /usr/local/bin/backup-claude-workflow.sh
```

---

## Security Best Practices

1. ✅ Store API keys only in Coolify UI (encrypted)
2. ✅ Never commit `.env` files to Git
3. ✅ Use SSL/HTTPS (Coolify handles this automatically)
4. ✅ Keep server updated: `apt update && apt upgrade`
5. ✅ Enable firewall: Allow only ports 80, 443, 22
6. ✅ Rotate API keys every 90 days
7. ✅ Monitor API usage at console.anthropic.com

---

## Troubleshooting Commands

```bash
# Check if containers are running
docker ps

# Check logs
docker logs <container-id>

# Check networks
docker network ls
docker network inspect coolify

# Restart containers
docker restart <container-id>

# Restart Traefik proxy
docker restart coolify-proxy

# Check Traefik logs
docker logs coolify-proxy | grep -i error
```

---

## Getting Help

**Coolify Issues:**
- Documentation: https://coolify.io/docs
- Discord: https://coollabs.io/discord
- GitHub: https://github.com/coollabsio/coolify/issues

**Application Issues:**
- Check `COOLIFY_DEPLOYMENT.md` for detailed guide
- Check `COOLIFY_CHECKLIST.md` for deployment checklist
- Review deployment logs in Coolify Dashboard

---

## Success Checklist

- [ ] Application deployed without errors
- [ ] Both containers show "healthy" status
- [ ] Frontend URL loads React application
- [ ] Backend `/health` endpoint returns 200 OK
- [ ] Can create and complete jobs
- [ ] Logs streaming in real-time
- [ ] SSL certificates valid (HTTPS working)
- [ ] No 404 errors
- [ ] Environment variables set correctly
- [ ] Backups configured

---

**Last Updated:** January 2025
**For:** Claude Workflow Manager v1.0
**Coolify Version:** v4.x
